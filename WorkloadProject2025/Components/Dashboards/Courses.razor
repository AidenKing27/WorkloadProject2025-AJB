@page "/coursedashboard"
@using System
@using System.Linq
@using System.Collections.Generic
@using System.Threading.Tasks
@using System.Text
@using System.Text.Json
@using Microsoft.JSInterop
@using MudBlazor
@using WorkloadProject2025.Data.Models
@using WorkloadProject2025.Services

@inject CourseService courseService
@inject ProgramOfStudyService programService
@inject IDialogService dialogService
@inject ISnackbar Snackbar
@inject IJSRuntime JS

<PageTitle>Course Dashboard</PageTitle>

<MudCard Class="mx-auto mt-6" Style="max-width: 1000px;">
    <MudCardHeader>
        <MudText Typo="Typo.h5" Class="font-semibold">Course Dashboard</MudText>
        <MudSpacer />
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ExportSelectedCourseCsv" Disabled="@(string.IsNullOrEmpty(SelectedCourseName))">
            Export Selected
        </MudButton>
    </MudCardHeader>

    <MudCardContent>
        <MudGrid Class="mb-4" AlignItems="Center">
            <MudItem Xs="12" Sm="6" Md="5">
                <MudSelect T="string"
                           Label="Select course"
                           Placeholder="-- Select a course --"
                           @bind-Value="SelectedCourseName"
                           Dense="true"
                           Variant="Variant.Outlined"
                           Clearable="true"
                           ResetValueOnEmptyText="true">
                    @foreach (var name in courseNames)
                    {
                        <MudSelectItem T="string" Value="@name">@name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem Xs="12" Sm="6" Md="7" Class="d-flex justify-end align-items-center">
                <MudText Typo="Typo.caption" Class="me-4">Total Courses: @courseNames.Length</MudText>
                <MudText Typo="Typo.caption">Total Hours: @totalCourseHours.ToString("0.##")</MudText>
            </MudItem>
        </MudGrid>

        @if (!string.IsNullOrEmpty(selectedCourseName))
        {
            <MudPaper Class="pa-4 mb-4" Elevation="1">
                <MudText Typo="Typo.h6">@GetDisplayTitle(selectedCourseName)</MudText>

                <MudGrid Class="mt-3">
                    <MudItem Xs="12" Md="6">
                        <MudText Typo="Typo.subtitle2" Class="mb-2">Course Details</MudText>
                        <MudPaper Class="pa-3" Elevation="0" Outlined="true">
                            <MudStack Spacing="2">
                                <div>
                                    <MudText Typo="Typo.caption" Class="text-secondary">Course Name</MudText>
                                    <MudText Typo="Typo.body2">@currentCourse.CourseName</MudText>
                                </div>
                                <div>
                                    <MudText Typo="Typo.caption" Class="text-secondary">Hours</MudText>
                                    <MudText Typo="Typo.body2">@currentCourse.Hours.ToString("0.##")</MudText>
                                </div>
                                <div>
                                    <MudText Typo="Typo.caption" Class="text-secondary">Program</MudText>
                                    <MudText Typo="Typo.body2">@currentCourse.ProgramName</MudText>
                                </div>
                                <div>
                                    <MudText Typo="Typo.caption" Class="text-secondary">Term</MudText>
                                    <MudText Typo="Typo.body2">@currentCourse.TermName</MudText>
                                </div>
                            </MudStack>
                        </MudPaper>
                    </MudItem>

                    <MudItem Xs="12" Md="6">
                        <MudText Typo="Typo.subtitle2">Faculty Teaching This Course</MudText>
                        @if (facultyTotals != null && facultyTotals.Any())
                        {
                            <MudTable Dense="true" Hover="true" Items="facultyTotals">
                                <HeaderContent>
                                    <MudTh>Faculty</MudTh>
                                    <MudTh Class="text-right">Workload Hours</MudTh>
                                    <MudTh>Section</MudTh>
                                </HeaderContent>
                                <RowTemplate Context="f">
                                    <MudTd DataLabel="Faculty">@f.FacultyName</MudTd>
                                    <MudTd DataLabel="Hours" Class="text-right">@f.Hours.ToString("0.##")</MudTd>
                                    <MudTd DataLabel="Section">@f.Section</MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Class="text-secondary">No faculty assigned to this course.</MudText>
                        }
                    </MudItem>
                </MudGrid>

                <MudGrid Class="mt-4">
                    <MudItem Xs="12" Md="12">
                        <MudText Typo="Typo.subtitle2" Class="mb-2">Workload Details</MudText>
                        @if (workloadDetails != null && workloadDetails.Any())
                        {
                            <MudTable Dense="true" Hover="true" Items="workloadDetails">
                                <HeaderContent>
                                    <MudTh>Faculty</MudTh>
                                    <MudTh>Section</MudTh>
                                    <MudTh>Course Type</MudTh>
                                    <MudTh Class="text-right">Hours</MudTh>
                                </HeaderContent>
                                <RowTemplate Context="w">
                                    <MudTd DataLabel="Faculty">@w.FacultyName</MudTd>
                                    <MudTd DataLabel="Section">@w.Section</MudTd>
                                    <MudTd DataLabel="Type">@w.CourseType</MudTd>
                                    <MudTd DataLabel="Hours" Class="text-right">@w.Hours.ToString("0.##")</MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Class="text-secondary">No workload details available for this course.</MudText>
                        }
                    </MudItem>
                </MudGrid>
            </MudPaper>
        }
        else
        {
            <MudText Typo="Typo.body2" Class="text-secondary">Select a course to view details.</MudText>
        }
    </MudCardContent>
</MudCard>

@code {
    private string[] courseNames = Array.Empty<string>();
    private string? selectedCourseName;
    private bool isLoading = false;
    private decimal totalCourseHours = 0M;

    // presentation records
    private record CourseDetail(string CourseName, decimal Hours, string ProgramName, string TermName);
    private record FacultyTotal(string FacultyName, decimal Hours, string Section);
    private record WorkloadDetail(string FacultyName, string Section, string CourseType, decimal Hours);

    private CourseDetail currentCourse = new("", 0M, "", "");
    private List<FacultyTotal> facultyTotals = new();
    private List<WorkloadDetail> workloadDetails = new();

    // TermId -> TermName map
    private Dictionary<int, string> termMap = new();

    private string SelectedCourseName
    {
        get => selectedCourseName ?? string.Empty;
        set
        {
            if (selectedCourseName == value) return;
            selectedCourseName = string.IsNullOrWhiteSpace(value) ? null : value;
            _ = InvokeAsync(() => LoadSelectedCourseByNameAsync(selectedCourseName));
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadCourseNamesAsync();

        if (courseNames.Any())
            SelectedCourseName = courseNames.First();
    }

    private async Task LoadCourseNamesAsync()
    {
        try
        {
            var courses = await courseService.GetAllAsync();

            courseNames = courses
                .Where(c => !string.IsNullOrWhiteSpace(c.Name))
                .Select(c => c.Name.Trim())
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .OrderBy(c => c, StringComparer.OrdinalIgnoreCase)
                .ToArray();

            // calculate total hours using Hours property if present, otherwise sum workloads
            totalCourseHours = 0M;
            var workloads = new List<Workload>();
            try { workloads = await courseService.GetAllWorkloadsAsync(); } catch { workloads = new List<Workload>(); }

            foreach (var c in courses)
            {
                decimal h = 0M;
                try
                {
                    var hv = c.GetType().GetProperty("Hours")?.GetValue(c);
                    if (hv is int hi) h = hi;
                    else if (hv is decimal hd) h = hd;
                    else if (hv is double hdbl) h = (decimal)hdbl;
                    else h = workloads.Where(w => w.CourseId == c.Id).Sum(w => (w.Hours ?? 0));
                }
                catch
                {
                    h = workloads.Where(w => w.CourseId == c.Id).Sum(w => (w.Hours ?? 0));
                }
                totalCourseHours += h;
            }

            // load term map
            try { termMap = (await courseService.GetDistinctTermIdNameMapAsync()).ToDictionary(k => k.Key, k => k.Value); } catch { termMap = new(); }
        }
        catch (Exception ex)
        {
            courseNames = Array.Empty<string>();
            totalCourseHours = 0M;
            Snackbar.Add($"Failed to load courses: {TrimMessage(ex.Message)}", Severity.Error);
        }
    }

    private string GetCourseTermNameFromCourse(Course c)
    {
        try
        {
            if (c == null) return "Unknown";

            var termProp = c.GetType().GetProperty("Term");
            if (termProp != null)
            {
                var termObj = termProp.GetValue(c);
                if (termObj != null)
                {
                    var nameProp = termObj.GetType().GetProperty("Name");
                    if (nameProp != null)
                    {
                        var val = nameProp.GetValue(termObj) as string;
                        if (!string.IsNullOrWhiteSpace(val)) return val.Trim();
                    }
                }
            }

            var termNameProp = c.GetType().GetProperty("TermName");
            if (termNameProp != null)
            {
                var val = termNameProp.GetValue(c) as string;
                if (!string.IsNullOrWhiteSpace(val)) return val.Trim();
            }

            var termIdProp = c.GetType().GetProperty("TermId");
            if (termIdProp != null)
            {
                var idVal = termIdProp.GetValue(c);
                if (idVal != null && int.TryParse(idVal.ToString(), out var tid))
                {
                    if (termMap != null && termMap.TryGetValue(tid, out var mapped)) return mapped;
                    return tid.ToString();
                }
            }
        }
        catch { }
        return "Unknown";
    }

    private async Task LoadSelectedCourseByNameAsync(string? name)
    {
        if (string.IsNullOrWhiteSpace(name))
        {
            currentCourse = new("", 0M, "", "");
            facultyTotals.Clear();
            workloadDetails.Clear();
            StateHasChanged();
            return;
        }

        if (isLoading) return;
        isLoading = true;

        try
        {
            if (termMap == null || !termMap.Any())
            {
                try { termMap = (await courseService.GetDistinctTermIdNameMapAsync()).ToDictionary(k => k.Key, k => k.Value); } catch { termMap = new(); }
            }

            var courses = await courseService.GetAllAsync();
            var course = courses.FirstOrDefault(c => string.Equals(c.Name?.Trim(), name.Trim(), StringComparison.OrdinalIgnoreCase));

            if (course == null)
            {
                Snackbar.Add("Course not found", Severity.Warning);
                return;
            }

            List<Workload> matchedWorkloads;
            try { matchedWorkloads = await courseService.GetWorkloadsByCourseIdAsync(course.Id); } catch { matchedWorkloads = new List<Workload>(); }

            // program name
            string programName = "Unknown";
            try
            {
                var progProp = course.GetType().GetProperty("Program");
                if (progProp != null)
                {
                    var progObj = progProp.GetValue(course);
                    if (progObj != null)
                    {
                        var nameProp = progObj.GetType().GetProperty("Name");
                        if (nameProp != null)
                            programName = nameProp.GetValue(progObj) as string ?? "Unknown";
                    }
                }

                if (programName == "Unknown" && course.GetType().GetProperty("ProgramId") != null)
                {
                    var pidProp = course.GetType().GetProperty("ProgramId")?.GetValue(course);
                    if (pidProp != null && int.TryParse(pidProp.ToString(), out var pid))
                    {
                        var programs = await programService.GetAllAsync();
                        var prog = programs.FirstOrDefault(p => p.Id == pid);
                        if (prog != null) programName = prog.Name ?? "Unknown";
                    }
                }
            }
            catch { }

            string termName = GetCourseTermNameFromCourse(course);

            decimal ch = 0M;
            try
            {
                var hv = course.GetType().GetProperty("Hours")?.GetValue(course);
                if (hv is int hi) ch = hi;
                else if (hv is decimal hd) ch = hd;
                else if (hv is double hdbl) ch = (decimal)hdbl;
                else ch = matchedWorkloads.Sum(w => (w.Hours ?? 0));
            }
            catch
            {
                ch = matchedWorkloads.Sum(w => (w.Hours ?? 0));
            }

            currentCourse = new CourseDetail(course.Name ?? "Unknown", ch, programName, termName);

            var facultyGroups = matchedWorkloads
                .GroupBy(w =>
                {
                    if (w.FacultyMember != null)
                    {
                        var first = w.FacultyMember.GetType().GetProperty("FirstName")?.GetValue(w.FacultyMember) as string;
                        var last = w.FacultyMember.GetType().GetProperty("LastName")?.GetValue(w.FacultyMember) as string;
                        var n = $"{first} {last}".Trim();
                        if (!string.IsNullOrWhiteSpace(n)) return n;
                        var nameProp = w.FacultyMember.GetType().GetProperty("Name")?.GetValue(w.FacultyMember) as string;
                        if (!string.IsNullOrWhiteSpace(nameProp)) return nameProp;
                    }
                    return w.FacultyEmail ?? "Unknown";
                })
                .Select(g => new
                {
                    FacultyName = g.Key,
                    TotalHours = g.Sum(x => (x.Hours ?? 0)),
                    Section = string.Join(", ", g.Select(x => x.Section ?? "").Where(s => !string.IsNullOrWhiteSpace(s)).Distinct())
                })
                .OrderByDescending(x => x.TotalHours)
                .ToList();

            facultyTotals = facultyGroups.Select(f => new FacultyTotal(f.FacultyName, f.TotalHours, f.Section)).ToList();

            workloadDetails = matchedWorkloads.Select(w => new WorkloadDetail(
                w.FacultyMember != null ?
                    ((w.FacultyMember.GetType().GetProperty("FirstName")?.GetValue(w.FacultyMember) as string ?? "") + " " +
                     (w.FacultyMember.GetType().GetProperty("LastName")?.GetValue(w.FacultyMember) as string ?? "")).Trim()
                    :
                    (w.FacultyEmail ?? "Unknown"),
                w.Section ?? "",
                w.GetType().GetProperty("CourseType")?.GetValue(w)?.ToString() ?? "",
                w.Hours ?? 0M
            )).OrderBy(w => w.FacultyName).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load course details: {TrimMessage(ex.Message)}", Severity.Error);
            currentCourse = new("", 0M, "", "");
            facultyTotals = new List<FacultyTotal>();
            workloadDetails = new List<WorkloadDetail>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private string GetDisplayTitle(string fullName)
    {
        if (string.IsNullOrWhiteSpace(fullName)) return string.Empty;
        // Show only the human-readable title after a dash if present: "ACCT101 - Financial Accounting" -> "Financial Accounting"
        var parts = fullName.Split(new[] { '-' }, 2);
        if (parts.Length == 2)
        {
            var title = parts[1].Trim();
            if (!string.IsNullOrWhiteSpace(title)) return title;
        }
        return fullName;
    }

    private async Task ExportSelectedCourseCsv()
    {
        if (string.IsNullOrEmpty(SelectedCourseName))
        {
            Snackbar.Add("Select a course first", Severity.Warning);
            return;
        }

        await EnsureBlazorDownloadJsAsync();

        try
        {
            var sb = new StringBuilder();
            sb.AppendLine($"\"Course: {SelectedCourseName}\"");
            sb.AppendLine($"\"Exported\",\"{DateTime.Now:yyyy-MM-dd HH:mm:ss}\"");
            sb.AppendLine();
            sb.AppendLine("\"Property\",\"Value\"");
            sb.AppendLine($"\"Course Name\",\"{currentCourse.CourseName}\"");
            sb.AppendLine($"\"Hours\",{currentCourse.Hours}");
            sb.AppendLine($"\"Program\",\"{currentCourse.ProgramName}\"");
            sb.AppendLine($"\"Term\",\"{currentCourse.TermName}\"");

            sb.AppendLine();
            sb.AppendLine("\"Faculty\",\"Section\",\"Hours\"");
            foreach (var f in facultyTotals)
            {
                var safeName = (f.FacultyName ?? "").Replace("\"", "\"\"");
                var safeSection = (f.Section ?? "").Replace("\"", "\"\"");
                sb.AppendLine($"\"{safeName}\",\"{safeSection}\",{f.Hours}");
            }

            var csvBytes = Encoding.UTF8.GetBytes(sb.ToString());
            var bom = new byte[] { 0xEF, 0xBB, 0xBF };
            var withBom = new byte[bom.Length + csvBytes.Length];
            Buffer.BlockCopy(bom, 0, withBom, 0, bom.Length);
            Buffer.BlockCopy(csvBytes, 0, withBom, bom.Length, csvBytes.Length);
            var base64 = Convert.ToBase64String(withBom);
            var fileName = $"course-{SelectedCourseName}-{DateTime.Now:yyyyMMddHHmmss}.csv";
            await JS.InvokeVoidAsync("blazorDownloadFile", fileName, base64, "text/csv;charset=utf-8;");
            Snackbar.Add("Course CSV exported", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Export failed: {TrimMessage(ex.Message)}", Severity.Error);
        }
    }

    private async Task EnsureBlazorDownloadJsAsync()
    {
        try
        {
            var exists = await JS.InvokeAsync<bool>("(function(){return !!window.blazorDownloadFile;})");
            if (!exists)
            {
                var js = @"
(function(){
  window.blazorDownloadFile = function (fileName, base64Data, contentType) {
    try {
      var link = document.createElement('a');
      link.href = 'data:' + (contentType || 'application/octet-stream') + ';base64,' + base64Data;
      link.setAttribute('download', fileName);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      return true;
    } catch (err) {
      console.error('blazorDownloadFile runtime injection failed', err);
      return false;
    }
  };
})();
";
                await JS.InvokeVoidAsync("eval", js);
            }
        }
        catch { /* ignore */ }
    }

    private string TrimMessage(string s) => s?.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries).FirstOrDefault() ?? s;
}