@page "/departmentdashboard"
@using System
@using System.Linq
@using System.Collections.Generic
@using System.Threading.Tasks
@using System.Text
@using Microsoft.JSInterop
@using MudBlazor
@using WorkloadProject2025.Data.Models

@inject DepartmentService departmentService
@inject WorkloadService workloadService
@inject IDialogService dialogService
@inject ISnackbar Snackbar
@inject IJSRuntime JS

<PageTitle>Department Dashboard</PageTitle>

<MudCard Class="mx-auto mt-6" Style="max-width: 1200px;">
    <MudCardHeader>
        <MudText Typo="Typo.h5" Class="font-semibold">Department Dashboard</MudText>
        <MudSpacer />
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ExportSelectedDepartmentCsv" Disabled="@(string.IsNullOrEmpty(SelectedDepartmentName))">
            Export Selected
        </MudButton>
    </MudCardHeader>

    <MudCardContent>
        <MudGrid Class="mb-4" AlignItems="Center">
            <MudItem Xs="12" Sm="6" Md="5">
                <MudSelect T="string"
                           Label="Select department"
                           Placeholder="-- Select a department --"
                           @bind-Value="SelectedDepartmentName"
                           Dense="true"
                           Variant="Variant.Outlined"
                           Clearable="true">
                    @foreach (var name in departmentNames)
                    {
                        <MudSelectItem T="string" Value="@name">@name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem Xs="12" Sm="6" Md="7" Class="d-flex justify-end align-items-center">
                <MudText Typo="Typo.caption" Class="me-4">Programs: @programTotals.Count</MudText>
                <MudText Typo="Typo.caption">Courses: @courseTotals.Count</MudText>
            </MudItem>
        </MudGrid>

        @if (!string.IsNullOrEmpty(selectedDepartmentName))
        {
            <MudPaper Class="pa-4 mb-4" Elevation="1">
                <MudText Typo="Typo.h6">@selectedDepartmentName</MudText>

                <MudGrid Class="mt-3">
                    <MudItem Xs="12" Md="6">
                        <MudText Typo="Typo.subtitle2">Programs (Total hours)</MudText>
                        <MudTable Dense="true" Hover="true" Items="programTotals">
                            <HeaderContent>
                                <MudTh>Program</MudTh>
                                <MudTh Class="text-right">Program Hours</MudTh>
                            </HeaderContent>
                            <RowTemplate Context="p">
                                <MudTd DataLabel="Program">@p.ProgramName</MudTd>
                                <MudTd DataLabel="Hours" Class="text-right">@p.TotalHours.ToString("0.##")</MudTd>
                            </RowTemplate>
                        </MudTable>
                    </MudItem>

                    <MudItem Xs="12" Md="6">
                        <MudText Typo="Typo.subtitle2">Courses (Total hours)</MudText>
                        <MudTable Dense="true" Hover="true" Items="courseTotals">
                            <HeaderContent>
                                <MudTh>Course</MudTh>
                                <MudTh Class="text-right">Course Hours</MudTh>
                            </HeaderContent>
                            <RowTemplate Context="c">
                                <MudTd DataLabel="Course">@c.CourseName</MudTd>
                                <MudTd DataLabel="Hours" Class="text-right">@c.TotalHours.ToString("0.##")</MudTd>
                            </RowTemplate>
                        </MudTable>
                    </MudItem>
                </MudGrid>

                @* department program chart *@
                <div class="mt-4">
                    <MudText Typo="Typo.subtitle2" Class="mb-2">Program Distribution</MudText>
                    @if (programData != null && programData.Any() && programData.Any(x => x > 0))
                    {
                        <MudChart ChartType="ChartType.Donut" Width="100%" Height="360px" InputData="programData.ToArray()" InputLabels="programLabels" />
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Class="text-secondary">No program hours available to render chart for this department.</MudText>
                    }
                </div>

                @* top courses & faculty charts/tables *@
                <MudGrid Class="mt-6" Gutter="Gutter.None">
                    <MudItem Xs="12" Md="6" Class="d-flex justify-center">
                        <MudPaper Class="pa-4" Style="width:100%;max-width:520px">
                            <MudText Typo="Typo.subtitle2" Class="mb-2">Top Courses by Hours</MudText>
                            @if (topCourseData != null && topCourseData.Any() && topCourseData.Any(v => v > 0))
                            {
                                <MudChart ChartType="ChartType.Pie" Width="100%" Height="360px" InputData="@(topCourseData.ToArray())" InputLabels="topCourseLabels"></MudChart>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2" Class="text-secondary">No course data available for this department.</MudText>
                            }
                        </MudPaper>
                    </MudItem>

                    <MudItem Xs="12" Md="6" Class="d-flex justify-center">
                        <MudPaper Class="pa-4" Style="width:100%;max-width:520px">
                            <MudText Typo="Typo.subtitle2" Class="mb-2">Faculty Hours Distribution</MudText>
                            @if (facultyData != null && facultyData.Any() && facultyData.Any(v => v > 0))
                            {
                                <MudChart ChartType="ChartType.Pie" Width="100%" Height="360px" InputData="@(facultyData.ToArray())" InputLabels="facultyLabels"></MudChart>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2" Class="text-secondary">No faculty assignments available for this department.</MudText>
                            }
                        </MudPaper>
                    </MudItem>
                </MudGrid>

                <MudGrid Class="mt-4">
                    <MudItem Xs="12" Md="12">
                        <MudText Typo="Typo.subtitle2" Class="mb-2">Faculty teaching this department</MudText>
                        @if (facultyTotals != null && facultyTotals.Any())
                        {
                            <MudTable Dense="true" Hover="true" Items="facultyTotals">
                                <HeaderContent>
                                    <MudTh>Faculty</MudTh>
                                    <MudTh Class="text-right">Total Hours</MudTh>
                                    <MudTh>Courses</MudTh>
                                </HeaderContent>
                                <RowTemplate Context="f">
                                    <MudTd DataLabel="Faculty">@f.FacultyName</MudTd>
                                    <MudTd DataLabel="Hours" Class="text-right">@f.TotalHours.ToString("0.##")</MudTd>
                                    <MudTd DataLabel="Courses">@string.Join(", ", f.Courses)</MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Class="text-secondary">No faculty data available for this department.</MudText>
                        }
                    </MudItem>
                </MudGrid>
            </MudPaper>
        }
        else
        {
            <MudText Typo="Typo.body2" Class="text-secondary">Select a department to view details.</MudText>
        }
    </MudCardContent>
</MudCard>

@code {
    private string[] departmentNames = Array.Empty<string>();
    private string? selectedDepartmentName;
    private bool isLoading = false;

    // presentation records
    private record ProgramTotal(string ProgramName, decimal TotalHours);
    private record CourseTotal(string CourseName, decimal TotalHours);
    private record FacultyTotal(string FacultyName, decimal TotalHours, List<string> Courses);

    private List<ProgramTotal> programTotals = new();
    private List<CourseTotal> courseTotals = new();
    private List<double> programData = new();
    private string[] programLabels = Array.Empty<string>();

    // top courses chart data
    private List<double> topCourseData = new();
    private string[] topCourseLabels = Array.Empty<string>();

    // faculty data
    private List<FacultyTotal> facultyTotals = new();
    private List<double> facultyData = new();
    private string[] facultyLabels = Array.Empty<string>();

    private string SelectedDepartmentName
    {
        get => selectedDepartmentName ?? string.Empty;
        set
        {
            if (selectedDepartmentName == value) return;
            selectedDepartmentName = string.IsNullOrWhiteSpace(value) ? null : value;
            _ = InvokeAsync(() => LoadSelectedDepartmentByNameAsync(selectedDepartmentName));
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadDepartmentNamesAsync();
        if (departmentNames.Any())
            SelectedDepartmentName = departmentNames.First();
    }

    private async Task LoadDepartmentNamesAsync()
    {
        try
        {
            var names = await departmentService.GetDistinctDepartmentNamesAsync();
            departmentNames = names
                .Where(n => !string.IsNullOrWhiteSpace(n))
                .Select(n => n.Trim())
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .OrderBy(n => n, StringComparer.OrdinalIgnoreCase)
                .ToArray();
        }
        catch (Exception ex)
        {
            departmentNames = Array.Empty<string>();
            Snackbar.Add($"Failed to load departments: {TrimMessage(ex.Message)}", Severity.Error);
        }
    }

    private async Task LoadSelectedDepartmentByNameAsync(string? name)
    {
        if (string.IsNullOrWhiteSpace(name))
        {
            programTotals.Clear();
            courseTotals.Clear();
            programData.Clear();
            programLabels = Array.Empty<string>();
            topCourseData.Clear();
            topCourseLabels = Array.Empty<string>();
            facultyTotals.Clear();
            facultyData.Clear();
            facultyLabels = Array.Empty<string>();
            StateHasChanged();
            return;
        }

        if (isLoading) return;
        isLoading = true;

        try
        {
            // load all Department rows that share this name
            var depts = await departmentService.GetByNameAsync(name);

            // gather all programs across these departments, dedupe by Id
            var allPrograms = depts
                .SelectMany(d => d.ProgramsOfStudy ?? Enumerable.Empty<ProgramOfStudy>())
                .GroupBy(p => p.Id)
                .Select(g => g.First())
                .ToList();

            // gather all courses across those programs, dedupe by Id
            var allCourses = allPrograms
                .SelectMany(p => p.Courses ?? Enumerable.Empty<Course>())
                .GroupBy(c => c.Id)
                .Select(g => g.First())
                .ToList();

            // Load workloads as fallback (if Course.Hours not present). workloads may include FacultyMember and Course navs.
            List<Workload> workloads;
            try
            {
                workloads = await workloadService.GetAllAsync();
            }
            catch
            {
                workloads = new List<Workload>();
            }

            // Compute program totals: prefer Course.Hours when present, otherwise sum workloads for courses in the program
            var progTotals = new List<ProgramTotal>();
            foreach (var p in allPrograms)
            {
                decimal total = 0M;
                var courses = p.Courses ?? Enumerable.Empty<Course>();
                if (courses.Any())
                {
                    foreach (var c in courses)
                    {
                        decimal ch = 0M;
                        try
                        {
                            var hv = c.GetType().GetProperty("Hours")?.GetValue(c);
                            if (hv is int hi) ch = hi;
                            else if (hv is decimal hd) ch = hd;
                            else if (hv is double hdbl) ch = (decimal)hdbl;
                            else ch = workloads.Where(w => w.CourseId == c.Id).Sum(w => (w.Hours ?? 0));
                        }
                        catch
                        {
                            ch = workloads.Where(w => w.CourseId == c.Id).Sum(w => (w.Hours ?? 0));
                        }
                        total += ch;
                    }
                }
                else
                {
                    total = workloads
                        .Where(w => w.Course != null && w.Course.GetType().GetProperty("ProgramId") != null && Convert.ToInt32(w.Course.GetType().GetProperty("ProgramId")!.GetValue(w.Course)!) == p.Id)
                        .Sum(w => (w.Hours ?? 0));
                }

                progTotals.Add(new ProgramTotal(p.Name ?? "Unknown", total));
            }

            programTotals = progTotals.OrderByDescending(x => x.TotalHours).ToList();

            // Compute course totals
            var courseTotalsList = new List<CourseTotal>();
            if (!allCourses.Any())
            {
                var grouped = workloads.Where(w => w.CourseId != 0).GroupBy(w => w.CourseId);
                foreach (var g in grouped)
                {
                    var any = g.FirstOrDefault();
                    string cname = any?.Course?.Name ?? $"Course {g.Key}";
                    decimal chTotal = g.Sum(x => (x.Hours ?? 0));
                    courseTotalsList.Add(new CourseTotal(cname, chTotal));
                }
            }
            else
            {
                foreach (var c in allCourses)
                {
                    decimal chTotal = 0M;
                    try
                    {
                        var hv = c.GetType().GetProperty("Hours")?.GetValue(c);
                        if (hv is int hi) chTotal = hi;
                        else if (hv is decimal hd) chTotal = hd;
                        else if (hv is double hdbl) chTotal = (decimal)hdbl;
                        else chTotal = workloads.Where(w => w.CourseId == c.Id).Sum(w => (w.Hours ?? 0));
                    }
                    catch
                    {
                        chTotal = workloads.Where(w => w.CourseId == c.Id).Sum(w => (w.Hours ?? 0));
                    }

                    courseTotalsList.Add(new CourseTotal(c.Name ?? $"Course {c.Id}", chTotal));
                }
            }

            courseTotals = courseTotalsList.OrderByDescending(x => x.TotalHours).ToList();

            // Prepare program chart arrays (for the department-level program distribution)
            programLabels = programTotals.Select(p => p.ProgramName ?? "Unknown").ToArray();
            programData = programTotals.Select(p => (double)p.TotalHours).ToList();

            // Prepare top courses chart (top 8 courses by hours)
            var topCourses = courseTotals.Take(8).ToList();
            topCourseLabels = topCourses.Select(c => c.CourseName).ToArray();
            topCourseData = topCourses.Select(c => (double)c.TotalHours).ToList();

            // ===== NEW: Build faculty breakdown from workloads =====
            // Relevant course ids for this department
            var relevantCourseIds = allCourses.Select(c => c.Id).ToHashSet();

            // Group workloads by faculty identity (prefer FacultyMember.Name if loaded, otherwise FacultyEmail)
            var facultyGroups = workloads
                .Where(w => w.CourseId.HasValue && relevantCourseIds.Contains(w.CourseId.Value))
                .GroupBy(w =>
                {
                    if (w.FacultyMember != null)
                    {
                        // try common name properties (Name / FullName) then email
                        var m = w.FacultyMember.GetType().GetProperty("Name")?.GetValue(w.FacultyMember) ??
                                w.FacultyMember.GetType().GetProperty("FullName")?.GetValue(w.FacultyMember);
                        return (m as string) ?? (w.FacultyEmail ?? "Unknown");
                    }
                    return (w.FacultyEmail ?? "Unknown");
                })
                .Select(g => new
                {
                    FacultyName = g.Key,
                    TotalHours = g.Sum(x => (x.Hours ?? 0)),
                    Courses = g.Select(x => x.Course != null ? (x.Course.Name ?? $"Course {x.CourseId}") : (x.CourseId != null ? $"Course {x.CourseId}" : "Unknown")).Distinct().ToList()
                })
                .OrderByDescending(x => x.TotalHours)
                .ToList();

            facultyTotals = facultyGroups.Select(f => new FacultyTotal(f.FacultyName, f.TotalHours, f.Courses)).ToList();
            facultyLabels = facultyTotals.Select(f => f.FacultyName).ToArray();
            facultyData = facultyTotals.Select(f => (double)f.TotalHours).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load department details: {TrimMessage(ex.Message)}", Severity.Error);
            programTotals = new List<ProgramTotal>();
            courseTotals = new List<CourseTotal>();
            programData.Clear();
            programLabels = Array.Empty<string>();
            topCourseData.Clear();
            topCourseLabels = Array.Empty<string>();
            facultyTotals = new List<FacultyTotal>();
            facultyData.Clear();
            facultyLabels = Array.Empty<string>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    // Export selected department (similar to school page) -- unchanged, but you can include faculty section if you want
    private async Task ExportSelectedDepartmentCsv()
    {
        if (string.IsNullOrEmpty(SelectedDepartmentName))
        {
            Snackbar.Add("Select a department first", Severity.Warning);
            return;
        }

        await EnsureBlazorDownloadJsAsync();

        try
        {
            var sb = new StringBuilder();
            sb.AppendLine($"\"Department: {SelectedDepartmentName}\"");
            sb.AppendLine($"\"Exported\",\"{DateTime.Now:yyyy-MM-dd HH:mm:ss}\"");
            sb.AppendLine();
            sb.AppendLine("\"Program\",\"ProgramHours\"");
            foreach (var p in programTotals)
                sb.AppendLine($"\"{p.ProgramName}\",{p.TotalHours}");

            sb.AppendLine();
            sb.AppendLine("\"Course\",\"CourseHours\"");
            foreach (var c in courseTotals)
                sb.AppendLine($"\"{c.CourseName}\",{c.TotalHours}");

            sb.AppendLine();
            sb.AppendLine("\"Faculty\",\"FacultyHours\",\"Courses\"");
            foreach (var f in facultyTotals)
            {
                var safeName = (f.FacultyName ?? "").Replace("\"", "\"\"");
                var courses = (f.Courses != null && f.Courses.Any()) ? string.Join(" | ", f.Courses) : "";
                sb.AppendLine($"\"{safeName}\",{f.TotalHours},\"{courses}\"");
            }

            var csvBytes = Encoding.UTF8.GetBytes(sb.ToString());
            var bom = new byte[] { 0xEF, 0xBB, 0xBF };
            var withBom = new byte[bom.Length + csvBytes.Length];
            Buffer.BlockCopy(bom, 0, withBom, 0, bom.Length);
            Buffer.BlockCopy(csvBytes, 0, withBom, bom.Length, csvBytes.Length);
            var base64 = Convert.ToBase64String(withBom);
            var fileName = $"department-{SelectedDepartmentName}-{DateTime.Now:yyyyMMddHHmmss}.csv";
            await JS.InvokeVoidAsync("blazorDownloadFile", fileName, base64, "text/csv;charset=utf-8;");
            Snackbar.Add("Department CSV exported", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Export failed: {TrimMessage(ex.Message)}", Severity.Error);
        }
    }

    private async Task EnsureBlazorDownloadJsAsync()
    {
        try
        {
            var exists = await JS.InvokeAsync<bool>("(function(){return !!window.blazorDownloadFile;})");
            if (!exists)
            {
                var js = @"
(function(){
  window.blazorDownloadFile = function (fileName, base64Data, contentType) {
    try {
      var link = document.createElement('a');
      link.href = 'data:' + (contentType || 'application/octet-stream') + ';base64,' + base64Data;
      link.setAttribute('download', fileName);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      return true;
    } catch (err) {
      console.error('blazorDownloadFile runtime injection failed', err);
      return false;
    }
  };
})();
";
                await JS.InvokeVoidAsync("eval", js);
            }
        }
        catch { /* ignore */ }
    }

    private string TrimMessage(string s) => s?.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries).FirstOrDefault() ?? s;
}