@page "/programdashboard"
@using System
@using System.Linq
@using System.Collections.Generic
@using System.Threading.Tasks
@using System.Text
@using Microsoft.JSInterop
@using MudBlazor
@using WorkloadProject2025.Data.Models
@using WorkloadProject2025.Services

@inject ProgramOfStudyService programService
@inject WorkloadService workloadService
@inject IDialogService dialogService
@inject ISnackbar Snackbar
@inject IJSRuntime JS

<PageTitle>Program Dashboard</PageTitle>

<MudCard Class="mx-auto mt-6" Style="max-width: 1200px;">
    <MudCardHeader>
        <MudText Typo="Typo.h5" Class="font-semibold">Program Dashboard</MudText>
        <MudSpacer />
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ExportSelectedProgramCsv" Disabled="@(string.IsNullOrEmpty(SelectedProgramName))">
            Export Selected
        </MudButton>
    </MudCardHeader>

    <MudCardContent>
        @if (!string.IsNullOrEmpty(loadError))
        {
            <MudAlert Severity="Severity.Error" Elevation="0" Class="mb-4">
                <div style="white-space:pre-wrap; font-family: monospace; font-size:0.9rem">@loadError</div>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="RetryLoad">Retry</MudButton>
            </MudAlert>
        }

        <MudGrid Class="mb-4" AlignItems="Center">
            <MudItem Xs="12" Sm="6" Md="4">
                <MudSelect T="string"
                           Label="Select program"
                           Placeholder="-- Select a program --"
                           @bind-Value="SelectedProgramName"
                           Dense="true"
                           Variant="Variant.Outlined"
                           Clearable="true">
                    @foreach (var name in programNames)
                    {
                        <MudSelectItem T="string" Value="@name">@name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem Xs="12" Sm="6" Md="4">
                <MudSelect T="string"
                           Label="Select term"
                           Placeholder="-- All terms --"
                           @bind-Value="SelectedTerm"
                           Dense="true"
                           Variant="Variant.Outlined"
                           Clearable="true">
                    <MudSelectItem T="string" Value="@string.Empty">All terms</MudSelectItem>
                    @foreach (var t in termNames)
                    {
                        <MudSelectItem T="string" Value="@t">@t</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem Xs="12" Sm="12" Md="4" Class="d-flex justify-end align-items-center">
                <MudText Typo="Typo.caption" Class="me-4">Programs: @programNames.Length</MudText>
                <MudText Typo="Typo.caption">Courses: @courseTotals.Count</MudText>
            </MudItem>
        </MudGrid>

        @if (!string.IsNullOrEmpty(selectedProgramName))
        {
            <MudPaper Class="pa-4 mb-4" Elevation="1">
                <MudText Typo="Typo.h6">@selectedProgramName @(string.IsNullOrWhiteSpace(SelectedTerm) ? "" : $"— {SelectedTerm}")</MudText>

                <MudGrid Class="mt-3">
                    <MudItem Xs="12" Md="6">
                        <MudText Typo="Typo.subtitle2">Courses (Total hours)</MudText>
                        <MudTable Dense="true" Hover="true" Items="courseTotals">
                            <HeaderContent>
                                <MudTh>Course</MudTh>
                                <MudTh Class="text-right">Course Hours</MudTh>
                            </HeaderContent>
                            <RowTemplate Context="c">
                                <MudTd DataLabel="Course">@c.CourseName</MudTd>
                                <MudTd DataLabel="Hours" Class="text-right">@c.TotalHours.ToString("0.##")</MudTd>
                            </RowTemplate>
                            <FooterContent>
                                <MudTd><b>Total</b></MudTd>
                                <MudTd Class="text-right"><b>@(courseTotals?.Sum(x => x.TotalHours).ToString("0.##") ?? "0")</b></MudTd>
                            </FooterContent>
                        </MudTable>
                    </MudItem>

                    @* Top Courses pie remains *@
                    <MudItem Xs="12" Md="6">
                        <MudText Typo="Typo.subtitle2">Top Courses (by Hours)</MudText>
                        @if (topCourseData != null && topCourseData.Any() && topCourseData.Any(v => v > 0))
                        {
                            <MudChart ChartType="ChartType.Pie" Width="100%" Height="360px" InputData="@(topCourseData.ToArray())" InputLabels="topCourseLabels"></MudChart>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Class="text-secondary">No course data available for this program/term.</MudText>
                        }
                    </MudItem>
                </MudGrid>

                <MudGrid Class="mt-6" Gutter="Gutter.None">
                    <MudItem Xs="12" Md="6" Class="d-flex justify-center">
                        <MudPaper Class="pa-4" Style="width:100%;max-width:520px">
                            <MudText Typo="Typo.subtitle2" Class="mb-2">Faculty Hours Distribution</MudText>
                            @if (facultyData != null && facultyData.Any() && facultyData.Any(v => v > 0))
                            {
                                <MudChart ChartType="ChartType.Pie" Width="100%" Height="360px" InputData="@(facultyData.ToArray())" InputLabels="facultyLabels"></MudChart>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2" Class="text-secondary">No faculty assignments available for this program/term.</MudText>
                            }
                        </MudPaper>
                    </MudItem>

                    <MudItem Xs="12" Md="6" Class="d-flex justify-center">
                        <MudPaper Class="pa-4" Style="width:100%;max-width:520px">
                            <MudText Typo="Typo.subtitle2" Class="mb-2">(Summary) Program Totals</MudText>
                            @if (programTotals != null && programTotals.Any())
                            {
                                <MudTable Dense="true" Items="programTotals">
                                    <HeaderContent>
                                        <MudTh>Program</MudTh>
                                        <MudTh Class="text-right">Total Hours</MudTh>
                                    </HeaderContent>
                                    <RowTemplate Context="p">
                                        <MudTd DataLabel="Program">@p.ProgramName</MudTd>
                                        <MudTd DataLabel="Hours" Class="text-right">@p.TotalHours.ToString("0.##")</MudTd>
                                    </RowTemplate>
                                </MudTable>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2" Class="text-secondary">No program totals available for this selection.</MudText>
                            }
                        </MudPaper>
                    </MudItem>
                </MudGrid>

                <MudGrid Class="mt-4">
                    <MudItem Xs="12" Md="12">
                        <MudText Typo="Typo.subtitle2" Class="mb-2">Faculty teaching this program</MudText>
                        @if (facultyTotals != null && facultyTotals.Any())
                        {
                            <MudTable Dense="true" Hover="true" Items="facultyTotals">
                                <HeaderContent>
                                    <MudTh>Faculty</MudTh>
                                    <MudTh Class="text-right">Total Hours</MudTh>
                                    <MudTh>Courses</MudTh>
                                </HeaderContent>
                                <RowTemplate Context="f">
                                    <MudTd DataLabel="Faculty">@f.FacultyName</MudTd>
                                    <MudTd DataLabel="Hours" Class="text-right">@f.TotalHours.ToString("0.##")</MudTd>
                                    <MudTd DataLabel="Courses">@string.Join(", ", f.Courses)</MudTd>
                                </RowTemplate>
                                <FooterContent>
                                    <MudTd><b>Total</b></MudTd>
                                    <MudTd Class="text-right"><b>@(facultyTotals?.Sum(x => x.TotalHours).ToString("0.##") ?? "0")</b></MudTd>
                                    <MudTd></MudTd>
                                </FooterContent>
                            </MudTable>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Class="text-secondary">No faculty data available for this program/term.</MudText>
                        }
                    </MudItem>
                </MudGrid>
            </MudPaper>
        }
        else
        {
            <MudText Typo="Typo.body2" Class="text-secondary">Select a program to view details.</MudText>
        }
    </MudCardContent>
</MudCard>

@code {
    private string[] programNames = Array.Empty<string>();
    private string[] termNames = Array.Empty<string>();
    private string? selectedProgramName;
    private string? selectedTerm;
    private bool isLoading = false;

    // debug
    private string? loadError;

    // cache
    private List<ProgramOfStudy> allProgramsCache = new();

    private record ProgramTotal(string ProgramName, decimal TotalHours);
    private record CourseTotal(string CourseName, decimal TotalHours);
    private record FacultyTotal(string FacultyName, decimal TotalHours, List<string> Courses);

    private List<ProgramTotal> programTotals = new();
    private List<CourseTotal> courseTotals = new();
    private List<double> courseData = new();
    private string[] courseLabels = Array.Empty<string>();

    private List<double> topCourseData = new();
    private string[] topCourseLabels = Array.Empty<string>();

    private List<FacultyTotal> facultyTotals = new();
    private List<double> facultyData = new();
    private string[] facultyLabels = Array.Empty<string>();

    private string SelectedProgramName
    {
        get => selectedProgramName ?? string.Empty;
        set
        {
            if (selectedProgramName == value) return;
            selectedProgramName = string.IsNullOrWhiteSpace(value) ? null : value;
            _ = InvokeAsync(() => { LoadSelectedProgramByNameAsync(selectedProgramName).ConfigureAwait(false); });
        }
    }

    private string SelectedTerm
    {
        get => selectedTerm ?? string.Empty;
        set
        {
            if (selectedTerm == value) return;
            selectedTerm = string.IsNullOrWhiteSpace(value) ? null : value;
            // reload current program view with new term filter
            _ = InvokeAsync(() => { LoadSelectedProgramByNameAsync(selectedProgramName).ConfigureAwait(false); });
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadProgramNamesAsync();
            if (programNames.Any())
                SelectedProgramName = programNames.First();
        }
        catch (Exception ex)
        {
            loadError = ex.ToString();
        }
    }

    private async Task RetryLoad()
    {
        loadError = null;
        await LoadProgramNamesAsync();
        if (!string.IsNullOrEmpty(SelectedProgramName))
            await LoadSelectedProgramByNameAsync(SelectedProgramName);
    }

    private string GetCourseTermName(Course c)
    {
        // Defensive: try common patterns for term name on Course
        try
        {
            if (c == null) return "Unknown";
            // Try navigation property Term.Name
            var termProp = c.GetType().GetProperty("Term");
            if (termProp != null)
            {
                var termObj = termProp.GetValue(c);
                if (termObj != null)
                {
                    var nameProp = termObj.GetType().GetProperty("Name");
                    if (nameProp != null)
                    {
                        var val = nameProp.GetValue(termObj) as string;
                        if (!string.IsNullOrWhiteSpace(val)) return val.Trim();
                    }
                }
            }

            // Try a direct TermName property on Course
            var termNameProp = c.GetType().GetProperty("TermName");
            if (termNameProp != null)
            {
                var val = termNameProp.GetValue(c) as string;
                if (!string.IsNullOrWhiteSpace(val)) return val.Trim();
            }

            // Fallback to TermId string if present
            var termIdProp = c.GetType().GetProperty("TermId");
            if (termIdProp != null)
            {
                var idVal = termIdProp.GetValue(c);
                if (idVal != null) return idVal.ToString() ?? "Unknown";
            }
        }
        catch { }
        return "Unknown";
    }

    private async Task LoadProgramNamesAsync()
    {
        try
        {
            var progs = await programService.GetAllAsync();
            allProgramsCache = progs ?? new List<ProgramOfStudy>();

            programNames = allProgramsCache
                .Where(p => !string.IsNullOrWhiteSpace(p.Name))
                .Select(p => p.Name!.Trim())
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .OrderBy(n => n, StringComparer.OrdinalIgnoreCase)
                .ToArray();

            // build term list from courses across all programs (defensive)
            var terms = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
            foreach (var prog in allProgramsCache)
            {
                var courses = prog.Courses ?? Enumerable.Empty<Course>();
                foreach (var c in courses)
                {
                    var t = GetCourseTermName(c);
                    if (!string.IsNullOrWhiteSpace(t) && t != "Unknown") terms.Add(t);
                }
            }
            termNames = terms.OrderBy(t => t).ToArray();
        }
        catch (Exception ex)
        {
            programNames = Array.Empty<string>();
            termNames = Array.Empty<string>();
            loadError = ex.ToString();
            Snackbar.Add($"Failed to load programs: {TrimMessage(ex.Message)}", Severity.Error);
        }
    }

    private async Task LoadSelectedProgramByNameAsync(string? name)
    {
        if (string.IsNullOrWhiteSpace(name))
        {
            programTotals.Clear();
            courseTotals.Clear();
            courseData.Clear();
            courseLabels = Array.Empty<string>();
            topCourseData.Clear();
            topCourseLabels = Array.Empty<string>();
            facultyTotals.Clear();
            facultyData.Clear();
            facultyLabels = Array.Empty<string>();
            StateHasChanged();
            return;
        }

        if (isLoading) return;
        isLoading = true;

        try
        {
            // ensure cache
            if (allProgramsCache == null || !allProgramsCache.Any())
                allProgramsCache = (await programService.GetAllAsync()) ?? new List<ProgramOfStudy>();

            var trimmed = name.Trim();
            var matchingPrograms = allProgramsCache
                .Where(p => p.Name != null && p.Name.Trim().Equals(trimmed, StringComparison.OrdinalIgnoreCase))
                .ToList();

            // gather courses for these programs
            var allCourses = matchingPrograms.SelectMany(p => p.Courses ?? Enumerable.Empty<Course>())
                                             .GroupBy(c => c.Id)
                                             .Select(g => g.First())
                                             .ToList();

            // if a term is selected, filter courses to that term
            if (!string.IsNullOrWhiteSpace(SelectedTerm))
            {
                allCourses = allCourses.Where(c => string.Equals(GetCourseTermName(c), SelectedTerm, StringComparison.OrdinalIgnoreCase)).ToList();
            }

            // workloads
            List<Workload> workloads;
            try
            {
                workloads = await workloadService.GetAllAsync();
            }
            catch
            {
                workloads = new List<Workload>();
            }

            // program totals (single selected program aggregated across matched rows)
            programTotals = matchingPrograms
                .Select(p =>
                {
                    decimal total = 0M;
                    var courses = p.Courses ?? Enumerable.Empty<Course>();
                    foreach (var c in courses)
                    {
                        // if term filter active, skip courses not in selected term
                        if (!string.IsNullOrWhiteSpace(SelectedTerm) && !string.Equals(GetCourseTermName(c), SelectedTerm, StringComparison.OrdinalIgnoreCase))
                            continue;

                        decimal ch = 0M;
                        try
                        {
                            var hv = c.GetType().GetProperty("Hours")?.GetValue(c);
                            if (hv is int hi) ch = hi;
                            else if (hv is decimal hd) ch = hd;
                            else if (hv is double hdbl) ch = (decimal)hdbl;
                            else ch = workloads.Where(w => w.CourseId == c.Id).Sum(w => (w.Hours ?? 0));
                        }
                        catch
                        {
                            ch = workloads.Where(w => w.CourseId == c.Id).Sum(w => (w.Hours ?? 0));
                        }
                        total += ch;
                    }
                    return new ProgramTotal(p.Name ?? "Unknown", total);
                })
                .OrderByDescending(x => x.TotalHours)
                .ToList();

            // course totals
            var ctList = new List<CourseTotal>();
            foreach (var c in allCourses)
            {
                decimal chTotal = 0M;
                try
                {
                    var hv = c.GetType().GetProperty("Hours")?.GetValue(c);
                    if (hv is int hi) chTotal = hi;
                    else if (hv is decimal hd) chTotal = hd;
                    else if (hv is double hdbl) chTotal = (decimal)hdbl;
                    else chTotal = workloads.Where(w => w.CourseId == c.Id).Sum(w => (w.Hours ?? 0));
                }
                catch
                {
                    chTotal = workloads.Where(w => w.CourseId == c.Id).Sum(w => (w.Hours ?? 0));
                }

                ctList.Add(new CourseTotal(c.Name ?? $"Course {c.Id}", chTotal));
            }
            courseTotals = ctList.OrderByDescending(x => x.TotalHours).ToList();

            // charts
            courseLabels = courseTotals.Select(c => c.CourseName ?? "Unknown").ToArray();
            courseData = courseTotals.Select(c => (double)c.TotalHours).ToList();

            var topCourses = courseTotals.Take(8).ToList();
            topCourseLabels = topCourses.Select(c => c.CourseName).ToArray();
            topCourseData = topCourses.Select(c => (double)c.TotalHours).ToList();

            // faculty grouping
            var relevantCourseIds = allCourses.Select(c => c.Id).ToHashSet();
            var facultyGroups = workloads
                .Where(w => w.CourseId.HasValue && relevantCourseIds.Contains(w.CourseId.Value))
                .GroupBy(w =>
                {
                    if (w.FacultyMember != null)
                    {
                        var name = w.FacultyMember.GetType().GetProperty("Name")?.GetValue(w.FacultyMember)
                                   ?? w.FacultyMember.GetType().GetProperty("FullName")?.GetValue(w.FacultyMember);
                        return (name as string) ?? (w.FacultyEmail ?? "Unknown");
                    }
                    return (w.FacultyEmail ?? "Unknown");
                })
                .Select(g => new
                {
                    FacultyName = g.Key,
                    TotalHours = g.Sum(x => (x.Hours ?? 0)),
                    Courses = g.Select(x => x.Course != null ? (x.Course.Name ?? $"Course {x.CourseId}") : (x.CourseId != null ? $"Course {x.CourseId}" : "Unknown")).Distinct().ToList()
                })
                .OrderByDescending(x => x.TotalHours)
                .ToList();

            facultyTotals = facultyGroups.Select(f => new FacultyTotal(f.FacultyName, f.TotalHours, f.Courses)).ToList();

            // unassigned courses (no workload rows)
            var coursesWithWorkloadIds = workloads.Where(w => w.CourseId.HasValue).Select(w => w.CourseId!.Value).ToHashSet();
            var unassignedCourses = allCourses.Where(c => !coursesWithWorkloadIds.Contains(c.Id)).ToList();
            if (unassignedCourses.Any())
            {
                var unassignedNames = unassignedCourses.Select(c => c.Name ?? $"Course {c.Id}").ToList();
                decimal unassignedHours = 0M;
                foreach (var uc in unassignedCourses)
                {
                    try
                    {
                        var hv = uc.GetType().GetProperty("Hours")?.GetValue(uc);
                        if (hv is int hi) unassignedHours += hi;
                        else if (hv is decimal hd) unassignedHours += hd;
                        else if (hv is double hdbl) unassignedHours += (decimal)hdbl;
                    }
                    catch { }
                }
                if (unassignedHours > 0 || !facultyTotals.Any())
                    facultyTotals.Insert(0, new FacultyTotal("Unassigned", unassignedHours, unassignedNames));
            }

            facultyLabels = facultyTotals.Select(f => f.FacultyName).ToArray();
            facultyData = facultyTotals.Select(f => (double)f.TotalHours).ToList();
        }
        catch (Exception ex)
        {
            loadError = ex.ToString();
            Snackbar.Add($"Failed to load program details: {TrimMessage(ex.Message)}", Severity.Error);
            programTotals = new List<ProgramTotal>();
            courseTotals = new List<CourseTotal>();
            facultyTotals = new List<FacultyTotal>();
            courseData.Clear();
            courseLabels = Array.Empty<string>();
            topCourseData.Clear();
            topCourseLabels = Array.Empty<string>();
            facultyData.Clear();
            facultyLabels = Array.Empty<string>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task ExportSelectedProgramCsv()
    {
        if (string.IsNullOrEmpty(SelectedProgramName))
        {
            Snackbar.Add("Select a program first", Severity.Warning);
            return;
        }

        await EnsureBlazorDownloadJsAsync();

        try
        {
            var sb = new StringBuilder();
            sb.AppendLine($"\"Program: {SelectedProgramName}\"");
            if (!string.IsNullOrWhiteSpace(SelectedTerm))
                sb.AppendLine($"\"Term: {SelectedTerm}\"");
            sb.AppendLine($"\"Exported\",\"{DateTime.Now:yyyy-MM-dd HH:mm:ss}\"");
            sb.AppendLine();
            sb.AppendLine("\"Course\",\"CourseHours\"");
            foreach (var c in courseTotals)
                sb.AppendLine($"\"{c.CourseName}\",{c.TotalHours}");

            sb.AppendLine();
            sb.AppendLine("\"Faculty\",\"FacultyHours\",\"Courses\"");
            foreach (var f in facultyTotals)
            {
                var safeName = (f.FacultyName ?? "").Replace("\"", "\"\"");
                var courses = (f.Courses != null && f.Courses.Any()) ? string.Join(" | ", f.Courses) : "";
                sb.AppendLine($"\"{safeName}\",{f.TotalHours},\"{courses}\"");
            }

            var csvBytes = Encoding.UTF8.GetBytes(sb.ToString());
            var bom = new byte[] { 0xEF, 0xBB, 0xBF };
            var withBom = new byte[bom.Length + csvBytes.Length];
            Buffer.BlockCopy(bom, 0, withBom, 0, bom.Length);
            Buffer.BlockCopy(csvBytes, 0, withBom, bom.Length, csvBytes.Length);
            var base64 = Convert.ToBase64String(withBom);
            var fileName = $"program-{SelectedProgramName}-{DateTime.Now:yyyyMMddHHmmss}.csv";
            await JS.InvokeVoidAsync("blazorDownloadFile", fileName, base64, "text/csv;charset=utf-8;");
            Snackbar.Add("Program CSV exported", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Export failed: {TrimMessage(ex.Message)}", Severity.Error);
        }
    }

    private async Task EnsureBlazorDownloadJsAsync()
    {
        try
        {
            var exists = await JS.InvokeAsync<bool>("(function(){return !!window.blazorDownloadFile;})");
            if (!exists)
            {
                var js = @"
(function(){
  window.blazorDownloadFile = function (fileName, base64Data, contentType) {
    try {
      var link = document.createElement('a');
      link.href = 'data:' + (contentType || 'application/octet-stream') + ';base64,' + base64Data;
      link.setAttribute('download', fileName);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      return true;
    } catch (err) {
      console.error('blazorDownloadFile runtime injection failed', err);
      return false;
    }
  };
})();
";
                await JS.InvokeVoidAsync("eval", js);
            }
        }
        catch { /* ignore */ }
    }

    private string TrimMessage(string s) => s?.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries).FirstOrDefault() ?? s;
}