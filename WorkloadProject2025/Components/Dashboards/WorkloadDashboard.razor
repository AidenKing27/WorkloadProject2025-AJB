@page "/workloaddashboard"

@inject FacultyService facultyService
@inject SchoolService schoolService
@inject DepartmentService departmentService
@inject ProgramOfStudyService programService
@inject CourseService courseService
@inject TermService termService
@inject WorkloadService workloadService
@inject IDialogService dialogService

@inject IJSRuntime JS
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>Workload Dashboard</PageTitle>

<MudCard Class="mx-auto mt-6" Style="max-width: 1400px;">
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h4" Class="font-semibold">Workload Dashboard</MudText>
        </CardHeaderContent>
    </MudCardHeader>

    <MudCardContent>
        <!-- KPIs -->
        <MudGrid Class="mb-4">
            <MudItem Xs="12" Sm="6" Md="3">
                <MudPaper Class="pa-4" Elevation="1">
                    <MudText Typo="Typo.caption">Total Faculty</MudText>
                    <MudText Typo="Typo.h5">@totalFaculty</MudText>
                </MudPaper>
            </MudItem>

            <MudItem Xs="12" Sm="6" Md="3">
                <MudPaper Class="pa-4" Elevation="1">
                    <MudText Typo="Typo.caption">Avg Workload Hours per Instructor</MudText>
                    <MudText Typo="Typo.h5">@averageWorkloadHours.ToString("F1")</MudText>
                </MudPaper>
            </MudItem>

            <MudItem Xs="12" Sm="6" Md="3">
                <MudPaper Class="pa-4" Elevation="1">
                    <MudText Typo="Typo.caption">Total Courses</MudText>
                    <MudText Typo="Typo.h5">@totalCourses</MudText>
                </MudPaper>
            </MudItem>

            <MudItem Xs="12" Sm="6" Md="3">
                <MudPaper Class="pa-4" Elevation="1">
                    <MudText Typo="Typo.caption">N/A</MudText>
                    <MudText Typo="Typo.h5">0</MudText>
                </MudPaper>
            </MudItem>
        </MudGrid>

        <MudGrid>
            <!-- Left: charts -->
            <MudItem Xs="12" Md="5">
@*                 <MudPaper Class="pa-4" Elevation="1">
                    <MudText Typo="Typo.h6">Workload Level Distribution</MudText>
                    @if (workloadPieSeries.Any())
                    {
                        <MudPaper Class="pa-4 mt-4 d-flex justify-center">
                            <MudChart ChartType="ChartType.Pie" ChartSeries="@workloadPieSeries" XAxisLabels="@workloadPieLabels" Width="320px" Height="320px" />
                        </MudPaper>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Class="text-secondary mt-4">No data</MudText>
                    }
                </MudPaper>

                <MudPaper Class="pa-4 mt-4" Elevation="1">
                    <MudText Typo="Typo.h6">Top Faculty Trend</MudText>
                    @if (trendSeries.Any())
                    {
                        <MudChart ChartType="ChartType.Line" ChartSeries="@trendSeries" XAxisLabels="@trendLabels" Width="100%" Height="260px" />
                    }
                </MudPaper> *@
            </MudItem>

            <!-- Right: table + export -->
            <MudItem Xs="12" Md="7">
                <MudPaper Class="pa-4" Elevation="1">
                    @* <div class="d-flex justify-between align-center mb-2">
                        <MudText Typo="Typo.h6">Faculty Workload (per professor)</MudText>
                        <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.FileDownload" OnClick="ExportAllFacultyCsv" Disabled="@(faculty2 == null || !faculty2.Any())">Export All</MudButton>
                    </div>

                    <MudTable Items="VisibleFaculty" Hover="true" Dense="true" Bordered="true" OnRowClick="OnFacultyRowClick">
                        <HeaderContent>
                            <MudTh>Faculty</MudTh>
                            <MudTh>Program</MudTh>
                            <MudTh>Courses</MudTh>
                            <MudTh>Workload (hrs)</MudTh>
                            <MudTh>Students</MudTh>
                            <MudTh Class="text-right">Actions</MudTh>
                        </HeaderContent>
                        <RowTemplate Context="f">
                            <MudTd>@f.Name</MudTd>
                            <MudTd>@f.Program</MudTd>
                            <MudTd>@f.CoursesCount</MudTd>
                            <MudTd>@f.WorkloadHours.ToString("F1")</MudTd>
                            <MudTd>@f.Students</MudTd>
                            <MudTd Class="d-flex justify-end">
                                <MudButton Size="Size.Small" Variant="Variant.Text" OnClick="@(() => ShowFaculty(f))">Details</MudButton>
                                <MudButton Size="Size.Small" Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => ExportFacultyCsv(f))">Export</MudButton>
                            </MudTd>
                        </RowTemplate>
                    </MudTable> *@
                </MudPaper>
            </MudItem>
        </MudGrid>

        <!-- Selected professor detail (sticky) -->
        <MudPaper Class="pa-4 mt-4" Style="position: sticky; top: 16px;">
            @if (selectedFaculty != null)
            {
                <MudText Typo="Typo.h6">@selectedFaculty.FirstName @selectedFaculty.LastName</MudText>
                <MudText Typo="Typo.body2">@selectedFaculty.Email • @selectedFaculty.PhoneNumber</MudText>

                <MudDivider Class="my-2" />

                <MudText Typo="Typo.subtitle2">Schedule / Courses</MudText>
@*                 @foreach (var c in selectedFaculty.Courses)
                {
                    <MudPaper Class="pa-2 mb-2" Elevation="0">
                        <MudText Typo="Typo.subtitle2">@c.Name</MudText>
                        <MudText Typo="Typo.caption">@c.DeliveryType — @c.Hours.ToString("F1") hrs • Students: @c.Students</MudText>
                    </MudPaper>
                }
                <MudDivider Class="my-2" />
                <MudText Typo="Typo.subtitle2">Workload Trend</MudText>
                @if (selectedFacultyTrendSeries.Any())
                {
                    <MudChart ChartType="ChartType.Line" ChartSeries="@selectedFacultyTrendSeries" XAxisLabels="@trendLabels" Width="100%" Height="200px" />
                } *@
            }
            else
            {
                <MudText Typo="Typo.body2">Select a faculty row to view details.</MudText>
            }
        </MudPaper>
    </MudCardContent>
</MudCard>

<MudCard Class="mx-auto mt-6" Style="max-width: 1400px;">
    <MudCardHeader>
        <CardHeaderContent>
            @if (selection != null)
            {
                <MudText Typo="Typo.h6" Class="font-semibold">Current Workloads for @selection.Name</MudText>
            }
            else
            {
                <MudText Typo="Typo.h6" Class="font-semibold">Current Workloads</MudText>
            }
        </CardHeaderContent>
        <CardHeaderActions>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenFormDialog">Add New Workload</MudButton>
        </CardHeaderActions>
    </MudCardHeader>

    <MudCardContent>
        <MudSelect Label="Filter by Program"
                   T="ProgramOfStudy"
                   Value="selection"
                   ValueChanged="OnSelectionChanged"
                   Immediate="true"
                   Dense="true"
                   Modal="true"
                   Adornment="Adornment.Start"
                   AdornmentIcon="@Icons.Material.Filled.Assessment">
            <MudSelectItem T="ProgramOfStudy" Value="@(null)">Select a Program</MudSelectItem>
            @foreach (var p in programs)
            {
                <MudSelectItem Value="@p">@p.Name</MudSelectItem>
            }
        </MudSelect>
    </MudCardContent>

    <MudCardContent>
        <MudStack Spacing="2">
            <MudDataGrid Items="tmpWorkloads"
                         T="Workload"
                         Dense="true"
                         ReadOnly="false"
                         EditMode="DataGridEditMode.Cell"
                         EditTrigger="DataGridEditTrigger.OnRowClick"
                         CommittedItemChanges="@OnCommittedItemChanges">
                <Columns>
                    <TemplateColumn Title="Faculty"
                                    Editable="true">
                        <CellTemplate>
                            <MudText>@context.Item.FacultyMember.FirstName @context.Item.FacultyMember.LastName</MudText>
                        </CellTemplate>
                        <EditTemplate>
                            <MudSelect T="Faculty"
                                       Value="context.Item.FacultyMember"
                                       ValueChanged="async (Faculty f) => { context.Item.FacultyMember = f; await OnCommittedItemChanges(context.Item); }"
                                       Dense="true"
                                       Margin="Margin.Dense">
                                @foreach (var f in faculty)
                                {
                                    <MudSelectItem Value="@f">@f.FirstName @f.LastName</MudSelectItem>
                                }
                            </MudSelect>
                        </EditTemplate>
                    </TemplateColumn>

                    <TemplateColumn Title="Course"
                                    Editable="true">
                        <CellTemplate>
                            <MudText>@context.Item.Course.Name</MudText>
                        </CellTemplate>
                        <EditTemplate>
                            <MudSelect T="Course"
                                       Value="context.Item.Course"
                                       ValueChanged="async (Course c) => { context.Item.Course = c; await OnCommittedItemChanges(context.Item); }"
                                       Dense="true"
                                       Margin="Margin.Dense">
                                @foreach (var c in courses)
                                {
                                    <MudSelectItem Value="@c">@c.Name</MudSelectItem>
                                }
                            </MudSelect>
                        </EditTemplate>
                    </TemplateColumn>

                    <PropertyColumn Property="x => x.Section"
                                    Title="Section"
                                    Editable="true"
                                    CellStyle="width: 100px;" />

                    <PropertyColumn Property="x => x.Hours"
                                    Title="Hours"
                                    Editable="true"
                                    CellStyle="width: 100px;" />

                    <PropertyColumn Property="x => x.Term.Name"
                                    Title="Term"
                                    Editable="true"
                                    CellStyle="width: 100px;" />

                    <TemplateColumn Editable="false"
                                    CellClass="d-flex justify-end">
                        <CellTemplate>
                            <MudStack Row>
                                <MudButton Size="@Size.Small" Variant="@Variant.Filled" Color="@Color.Secondary"
                                           OnClick="() => DeleteRecord(context.Item)">Delete</MudButton>
                            </MudStack>
                        </CellTemplate>
                    </TemplateColumn>

                </Columns>
            </MudDataGrid>
        </MudStack>
    </MudCardContent>
</MudCard>

@code {

    private ProgramOfStudy? selection;
    private Faculty? selectedFaculty;
    private double averageWorkloadHours;
    private int totalFaculty;
    private int totalCourses;

    private Dictionary<string, string> uniqueFaculty = new Dictionary<string, string>();

    private List<Workload> workloads = new List<Workload>();
    private List<Workload> tmpWorkloads = new List<Workload>();
    private List<Faculty> faculty = new List<Faculty>();
    private List<School> schools = new List<School>();
    private List<Department> departments = new List<Department>();
    private List<ProgramOfStudy> programs = new List<ProgramOfStudy>();
    private List<Course> courses = new List<Course>();
    private List<Term> terms = new List<Term>();

    private Workload workload { get; set; } = new Workload();

    protected override async Task OnInitializedAsync()
    {
        workloads = await workloadService.GetAllAsync();
        tmpWorkloads = workloads;
        faculty = await facultyService.GetAllAsync();
        schools = await schoolService.GetAllAsync();
        departments = await departmentService.GetAllAsync();
        programs = await programService.GetAllAsync();
        courses = await courseService.GetAllAsync();
        terms = await termService.GetAllAsync();

        foreach (var w in workloads)
        {
            if (!uniqueFaculty.ContainsKey(w.FacultyEmail))
                uniqueFaculty.Add(w.FacultyEmail, w.FacultyMember.FirstName);

            averageWorkloadHours += (double)w.Hours!;
        }

        totalFaculty = uniqueFaculty.Count();
        averageWorkloadHours /= uniqueFaculty.Count();
        totalCourses = courses.Count();

    }

    private async Task OnCommittedItemChanges(Workload item)
    {
        try
        {
            if (item.FacultyMember != null)
            {
                item.FacultyEmail = item.FacultyMember.Email;
            }

            if (item.Course != null)
            {
                item.CourseId = item.Course.Id;
            }

            await workloadService.UpdateAsync(item);

            await ReloadData();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating workload: {ex.Message}");
        }
    }

    private void OnSelectionChanged(ProgramOfStudy newSelection)
    {
        selection = newSelection;

        if (selection != null)
        {
            tmpWorkloads = workloads.Where(x => selection.Courses.Contains(x.Course)).ToList();
        }
        else
        {
            tmpWorkloads = workloads;
        }

        StateHasChanged();
    }

    private async Task OpenFormDialog()
    {
        var parameters = new DialogParameters<WorkloadForm>
        {
            { x => x.Faculty, faculty },
            { x => x.Schools, schools },
            { x => x.Departments, departments },
            { x => x.Programs, programs },
            { x => x.Courses, courses },
            { x => x.Terms, terms }
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            FullWidth = true,
            MaxWidth = MaxWidth.Small
        };

        var dialog = await dialogService.ShowAsync<WorkloadForm>("Add New Workload", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await ReloadData();
        }
    }

    private async Task<bool> DeleteRecord(Workload workload)
    {
        bool result = await workloadService.DeleteAsync(workload);
        await ReloadData();

        return result;
    }

    public async Task ReloadData()
    {
        workloads = await workloadService.GetAllAsync();
        tmpWorkloads = workloads.Where(x => selection == null || selection.Courses.Contains(x.Course)).ToList();
        StateHasChanged();
    }
















    // public class FacultyModel
    // {
    //     public string Name { get; set; } = "";
    //     public string Program { get; set; } = "";
    //     public int CoursesCount { get; set; }
    //     public double WorkloadHours { get; set; }
    //     public int Students { get; set; }
    //     public string Email { get; set; } = "";
    //     public string Phone { get; set; } = "";
    //     public List<Course> Courses { get; set; } = new();
    // }

    // State
    

    //// VisibleFaculty (used by table) — deterministic filter/search (kept simple)
    // private IEnumerable<FacultyModel> VisibleFaculty => faculty2
    //     .Where(f => string.IsNullOrWhiteSpace(fProgramFilter) || f.Program == fProgramFilter)
    //     .OrderByDescending(f => f.WorkloadHours);

    // // simple program filter backing field (if you'd like to expose UI for program filter later)
    // private string fProgramFilter = string.Empty;

    // // Charts
    // private List<ChartSeries> workloadPieSeries = new();
    // private string[] workloadPieLabels = Array.Empty<string>();

    // private List<ChartSeries> trendSeries = new();
    // private string[] trendLabels = new[] { "Fall 2023", "Spring 2024", "Summer 2024", "Fall 2024" };

    //private List<ChartSeries> selectedFacultyTrendSeries = new();

    // private void Recalculate()
    // {
    //     BuildWorkloadPie();
    //     BuildTrend();
    //     BuildSelectedFacultyTrend(faculty2.OrderByDescending(f => f.WorkloadHours).FirstOrDefault());
    // }

    // private void BuildWorkloadPie()
    // {
    //     var low = faculty2.Count(f => f.WorkloadHours <= 10);
    //     var med = faculty2.Count(f => f.WorkloadHours > 10 && f.WorkloadHours <= 15);
    //     var high = faculty2.Count(f => f.WorkloadHours > 15);
    //     workloadPieLabels = new[] { "Low (<=10)", "Medium (10-15)", "High (>15)" };
    //     workloadPieSeries = new List<ChartSeries> { new ChartSeries { Name = "Workload Levels", Data = new double[] { low, med, high } } };
    // }

    // private void BuildTrend()
    // {
    //     var top = faculty2.OrderByDescending(f => f.WorkloadHours).Take(3).ToList();
    //     trendSeries = top.Select(f => new ChartSeries
    //     {
    //         Name = f.Name,
    //         Data = new double[]
    //         {
    //             Math.Round(f.WorkloadHours * 0.9, 1),
    //             Math.Round(f.WorkloadHours * 0.95, 1),
    //             Math.Round(f.WorkloadHours * 1.0, 1),
    //             Math.Round(f.WorkloadHours * 1.05, 1)
    //         }
    //     }).ToList();
    // }

    // private void BuildSelectedFacultyTrend(Faculty? f)
    // {
    //     selectedFaculty = f;
    //     selectedFacultyTrendSeries = new List<ChartSeries>();
    //     if (f == null) return;
    //     selectedFacultyTrendSeries = new List<ChartSeries>
    //     {
    //         new ChartSeries { Name = f.FirstName, Data = new double[] {
    //             Math.Round(f.WorkloadHours * 0.9, 1),
    //             Math.Round(f.WorkloadHours * 0.95, 1),
    //             Math.Round(f.WorkloadHours * 1.0, 1),
    //             Math.Round(f.WorkloadHours * 1.05, 1)
    //         } }
    //     };
    // }

    // private void OnFacultyRowClick(TableRowClickEventArgs<FacultyModel> args)
    // {
    //     BuildSelectedFacultyTrend(args.Item);
    // }

    // private void ShowFaculty(FacultyModel f)
    // {
    //     var courses = string.Join(", ", f.Courses.Select(c => c.Name));
    //     Snackbar.Add($"{f.Name} — {f.Program}: {f.CoursesCount} courses ({courses}) • {f.WorkloadHours:F1} hrs • {f.Students} students", Severity.Info);
    // }

    // private async Task ExportFacultyCsv(FacultyModel f)
    // {
    //     var sb = new StringBuilder();
    //     sb.AppendLine("Name,Program,Courses,WorkloadHours,Students,Email,Phone");
    //     var courses = string.Join(" | ", f.Courses.Select(c => c.Name));
    //     sb.AppendLine($"\"{f.Name}\",\"{f.Program}\",\"{courses}\",{f.WorkloadHours},{f.Students},\"{f.Email}\",\"{f.Phone}\"");
    //     var bytes = Encoding.UTF8.GetBytes(sb.ToString());
    //     await JS.InvokeVoidAsync("blazorDownloadFile", $"faculty-{f.Name}-{DateTime.Now:yyyyMMdd}.csv", Convert.ToBase64String(bytes), "text/csv");
    //     Snackbar.Add("Exported CSV", Severity.Success);
    // }

    // private async Task ExportAllFacultyCsv()
    // {
    //     var sb = new StringBuilder();
    //     sb.AppendLine("Name,Program,Courses,WorkloadHours,Students,Email,Phone");
    //     foreach (var f in faculty2)
    //         sb.AppendLine($"\"{f.Name}\",\"{f.Program}\",{f.CoursesCount},{f.WorkloadHours},{f.Students},\"{f.Email}\",\"{f.Phone}\"");
    //     var bytes = Encoding.UTF8.GetBytes(sb.ToString());
    //     await JS.InvokeVoidAsync("blazorDownloadFile", $"workload-all-{DateTime.Now:yyyyMMdd}.csv", Convert.ToBase64String(bytes), "text/csv");
    //     Snackbar.Add("Exported CSV", Severity.Success);
    // }
}