@page "/departmentdashboardpage"

@inject DepartmentService departmentService
@inject ProgramOfStudyService programService

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h3" Class="mb-4">Department Prototype Dashboard</MudText>

    <MudGrid>
        <MudItem xs="12" md="8">
            <MudCard Class="pa-4">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Department Information</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudDataGrid Items="@departments" Hover="true" Dense="true" Filterable="true" SortMode="SortMode.Multiple">
                        <Columns>
                            <PropertyColumn Property="x => x.Name" Title="Department" />
                            <TemplateColumn Title="Programs" Sortable="false">
                                <CellTemplate>
                                    @{
                                        var deptCount = programs.Count(d => d.DepartmentId == context.Item.Id);
                                    }
                                    <MudChip T="int" Color="Color.Primary" Size="Size.Small">@deptCount</MudChip>
                                </CellTemplate>
                            </TemplateColumn>
                        </Columns>
                    </MudDataGrid>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudCard Class="pa-4">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Programs per Department</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudTable Items="@departmentStats" Hover="true" Dense="true">
                        <HeaderContent>
                            <MudTh>Department</MudTh>
                            <MudTh>Programs</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.DepartmentName</MudTd>
                            <MudTd>
                                <MudChip T="int" Color="Color.Primary" Size="Size.Small">@context.ProgramOfStudyCount</MudChip>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudCard Class="pa-4">
                <MudCardContent>
                    <MudStack AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.Factory" Size="Size.Large" Color="Color.Primary" />
                        <MudText Typo="Typo.h4">@totalDepartments</MudText>
                        <MudText Typo="Typo.body2">Total Departments</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudCard Class="pa-4">
                <MudCardContent>
                    <MudStack AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.Assessment" Size="Size.Large" Color="Color.Secondary" />
                        <MudText Typo="Typo.h4">@totalPrograms</MudText>
                        <MudText Typo="Typo.body2">Total Programs</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudCard Class="pa-4">
                <MudCardContent>
                    <MudStack AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.Calculate" Size="Size.Large" Color="Color.Tertiary" />
                        <MudText Typo="Typo.h4">@averageProgramsPerDepartment.ToString("F1")</MudText>
                        <MudText Typo="Typo.body2">Average Programs per Department</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private List<Department> departments = new();
    private List<ProgramOfStudy> programs = new();
    private List<DepartmentStats> departmentStats = new();
    private int totalDepartments;
    private int totalPrograms;
    private double averageProgramsPerDepartment;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        departments = await departmentService.GetAllAsync();
        programs = await programService.GetAllAsync();

        totalDepartments = departments.Count;
        totalPrograms = programs.Count;
        averageProgramsPerDepartment = totalDepartments > 0 ? (double)totalPrograms / totalDepartments : 0;

        departmentStats = departments.Select(Department => new DepartmentStats
        {
            DepartmentName = Department.Name,
            ProgramOfStudyCount = programs.Count(d => d.DepartmentId == Department.Id)
        }).OrderByDescending(s => s.ProgramOfStudyCount).ToList();
    }

    public class DepartmentStats
    {
        public string DepartmentName { get; set; } = string.Empty;
        public int ProgramOfStudyCount { get; set; }
    }
}