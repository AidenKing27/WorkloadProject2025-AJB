@page "/schooldashboardpage"

@inject SchoolService _schoolService
@inject DepartmentService _departmentService

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h3" Class="mb-4">School Prototype Dashboard</MudText>
    
    <MudGrid>
        <MudItem xs="12" md="8">
            <MudCard Class="pa-4">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Schools Information</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudDataGrid Items="@schools" Hover="true" Dense="true" Filterable="true" SortMode="SortMode.Multiple">
                        <Columns>
                            <PropertyColumn Property="x => x.Name" Title="School Name" />
                            <TemplateColumn Title="Departments" Sortable="false">
                                <CellTemplate>
                                    @{
                                        var deptCount = departments.Count(d => d.SchoolId == context.Item.Id);
                                    }
                                    <MudChip T="int" Color="Color.Primary" Size="Size.Small">@deptCount</MudChip>
                                </CellTemplate>
                            </TemplateColumn>
                        </Columns>
                    </MudDataGrid>
                </MudCardContent>
            </MudCard>
        </MudItem>
        
        <MudItem xs="12" md="4">
            <MudCard Class="pa-4">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Departments per School</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudTable Items="@schoolStats" Hover="true" Dense="true">
                        <HeaderContent>
                            <MudTh>School</MudTh>
                            <MudTh>Departments</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.SchoolName</MudTd>
                            <MudTd>
                                <MudChip T="int" Color="Color.Primary" Size="Size.Small">@context.DepartmentCount</MudChip>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudCardContent>
            </MudCard>
        </MudItem>
        
        <MudItem xs="12" md="4">
            <MudCard Class="pa-4">
                <MudCardContent>
                    <MudStack AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.School" Size="Size.Large" Color="Color.Primary" />
                        <MudText Typo="Typo.h4">@totalSchools</MudText>
                        <MudText Typo="Typo.body2">Total Schools</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        
        <MudItem xs="12" md="4">
            <MudCard Class="pa-4">
                <MudCardContent>
                    <MudStack AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.Assessment" Size="Size.Large" Color="Color.Secondary" />
                        <MudText Typo="Typo.h4">@totalDepartments</MudText>
                        <MudText Typo="Typo.body2">Total Departments</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        
        <MudItem xs="12" md="4">
            <MudCard Class="pa-4">
                <MudCardContent>
                    <MudStack AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.Calculate" Size="Size.Large" Color="Color.Tertiary" />
                        <MudText Typo="Typo.h4">@averageDepartmentsPerSchool.ToString("F1")</MudText>
                        <MudText Typo="Typo.body2">Average Departments per School</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private List<School> schools = new();
    private List<Department> departments = new();
    private List<SchoolStats> schoolStats = new();
    private int totalSchools;
    private int totalDepartments;
    private double averageDepartmentsPerSchool;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        schools = await _schoolService.GetAllAsync();
        departments = await _departmentService.GetAllAsync();
        
        totalSchools = schools.Count;
        totalDepartments = departments.Count;
        averageDepartmentsPerSchool = totalSchools > 0 ? (double)totalDepartments / totalSchools : 0;
        
        schoolStats = schools.Select(school => new SchoolStats
        {
            SchoolName = school.Name,
            DepartmentCount = departments.Count(d => d.SchoolId == school.Id)
        }).OrderByDescending(s => s.DepartmentCount).ToList();
    }

    public class SchoolStats
    {
        public string SchoolName { get; set; } = string.Empty;
        public int DepartmentCount { get; set; }
    }
}
